<template lang="html">
  <div class="model-section-elements">

    <div class="slider-container">
      <transition name="slideDownUp">
        <app-model-card-modal v-if="showCardModal"
          :isNew="false"
          :cardWrapperId="$route.params.cardId"
          :inSectionId="sectionId"
          :inSectionTitle="sectionTitle"
          @close="closeCardModal()"
          @update="resetCards()"
          @updateCards="resetCards()">
        </app-model-card-modal>
      </transition>

      <transition name="slideDownUp">
        <app-model-card-modal
          v-if="showNewCardModal"
          :isNew="true"
          :inSectionId="section.id"
          :inSectionTitle="section.title"
          @close="showNewCardModal = false"
          @updateCards="update()">
        </app-model-card-modal>
      </transition>
    </div>

    <div class="model-section-elements-container">
      <div class="w3-row controls-row small-scroll">

        <div class="control-group">
          <popper trigger="hover":options="popperOptions">
            <app-help-popper
              :title="$t('help.MESSAGES-TAB-TT')"
              :details="$t('help.MESSAGES-TAB-DET')">
            </app-help-popper>

            <div slot="reference" @click="messagesContent()" class="w3-left control-btn" :class="{'control-btn-selected': isMessagesContent}">
              <img src="./../../assets/chat-icon.svg" alt="">
            </div>
          </popper>

          <popper trigger="hover" :options="popperOptions">
            <app-help-popper
              :title="$t('help.CARDS-SUMMARY-TAB-TT')"
              :details="$t('help.CARDS-SUMMARY-TAB-DET')">
            </app-help-popper>

            <div slot="reference" @click="summaryView()" class="w3-left control-btn" :class="{'control-btn-selected': isSummary}">
              <img src="./../../assets/rows-icon.svg" alt="">
            </div>
          </popper>

          <popper trigger="hover" :options="popperOptions">
            <app-help-popper
              :title="$t('help.CARDS-TAB-TT')"
              :details="$t('help.CARDS-TAB-DET')">
            </app-help-popper>

            <div slot="reference" @click="cardView()" class="w3-left control-btn" :class="{'control-btn-selected': isCard}">
              <img src="./../../assets/cards-icon.svg" alt="">
            </div>
          </popper>

          <popper trigger="hover" :options="popperOptions">
            <app-help-popper
              :title="$t('help.CARDS-DOC-VIEW-TT')"
              :details="$t('help.CARDS-DOC-VIEW-DET')">
            </app-help-popper>

            <div slot="reference" @click="docView()" class="w3-left control-btn" :class="{'control-btn-selected': isDoc}">
              <img src="./../../assets/doc-icon.svg" alt="">
            </div>
          </popper>

        </div>

        <div v-if="isCardsContent" class="control-group noselect">
          <div class="w3-left zoom-controls">
            <div class="w3-left zoom-controls-enabled">
              <popper trigger="hover":options="popperOptions">
                <app-help-popper
                  :title="$t('help.REDUCE-LEVELS-TT')"
                  :details="$t('help.REDUCE-LEVELS-DET')">
                </app-help-popper>

                <div slot="reference" @click="levelDown()" class="w3-left cursor-pointer arrow-div">
                  <img src="./../../assets/zoom-in-icon.svg" alt="">
                </div>
              </popper>

              <div class="w3-left number-div">
                {{ levels !== 999 ? levels : '&#x221e;' }}
              </div>

              <popper trigger="hover":options="popperOptions">
                <app-help-popper
                  :title="$t('help.INCREASE-LEVELS-TT')"
                  :details="$t('help.INCREASE-LEVELS-DET')">
                </app-help-popper>

                <div slot="reference" @click="levelUp()" class="w3-left cursor-pointer arrow-div">
                  <img src="./../../assets/zoom-out-icon.svg" alt="">
                </div>
              </popper>

              <!-- <div v-if="infiniteLevels" class="zoom-controls-cover">
              </div> -->
            </div>

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="$t('help.SEE-ALL-LEVELS-TT')"
                :details="$t('help.SEE-ALL-LEVELS-DET')">
              </app-help-popper>

              <div slot="reference" @click="toggleInifinteLevels()" class="w3-left cursor-pointer arrow-div w3-border-left" :class="{'control-btn-selected': infiniteLevels}">
                <img src="./../../assets/infinite-icon.svg" alt="">
              </div>
            </popper>

          </div>
        </div>

        <div v-if="isCardsContent && this.$store.state.user.authenticated" class="control-group">
          <div class="">
            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="(showPrivate ? $t('general.HIDE') : $t('general.SHOW')) + ' ' + $t('help.PRIVATE-CARDS-TT')"
                :details="$t('help.PRIVATE-CARDS-DET')">
              </app-help-popper>

              <div slot="reference" @click="showPrivateClick()" class="w3-left control-btn border-red" :class="{'control-btn-selected': showPrivate, 'w3-bottombar': showPrivate}">
                <img src="./../../assets/private-icon.svg" alt="">
              </div>
            </popper>

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="(showShared ? $t('general.HIDE') : $t('general.SHOW')) + ' ' + $t('help.SHARED-CARDS-TT')"
                :details="$t('help.SHARED-CARDS-DET')">
              </app-help-popper>

              <div slot="reference" @click="showSharedClick()" class="w3-left control-btn border-yellow" :class="{'control-btn-selected': showShared, 'w3-bottombar': showShared}">
                <img src="./../../assets/shared-icon.svg" alt="">
              </div>
            </popper>

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="(showCommon ? $t('general.HIDE') : $t('general.SHOW')) + ' ' + $t('help.COMMON-CARDS-TT')"
                :details="$t('help.COMMON-CARDS-DET')">
              </app-help-popper>

              <div slot="reference" @click="showCommonClick()" class="w3-left control-btn border-blue" :class="{'control-btn-selected': showCommon, 'w3-bottombar': showCommon}">
                <img src="./../../assets/common-icon.svg" alt="">
              </div>
            </popper>

          </div>
        </div>

        <div v-if="isCardsContent" class="control-group">
          <div class="">
            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="$t('help.SHOW-SECTION-ORDER-TT')"
                :details="$t('help.SHOW-SECTION-ORDER-DET')">
              </app-help-popper>

              <div slot="reference"  @click="sectionOrder()" class="w3-left control-btn" :class="{'control-btn-selected': isSectionsOrder}">
                <img src="./../../assets/network-icon.svg" alt="">
              </div>
            </popper>

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="$t('help.SEARCH-CARDS-TT')"
                :details="$t('help.SEARCH-CARDS-DET')">
              </app-help-popper>

              <div slot="reference" @click="aggregatedOrder()" class="w3-left control-btn" :class="{'control-btn-selected': !isSectionsOrder}">
                <img src="./../../assets/search-icon.svg" alt="">
              </div>
            </popper>

          </div>
        </div>

        <div v-if="!isCardsContent" class="control-group">
          <popper trigger="hover":options="popperOptions">
            <app-help-popper
              :title="(showMessages ? $t('general.HIDE') : $t('general.SHOW')) + ' ' + $t('help.SHOW-MESSAGES-TT')"
              :details="$t('help.SHOW-MESSAGES-DET')">
            </app-help-popper>

            <div slot="reference" @click="showMessages = !showMessages" class="w3-left control-btn" :class="{'control-btn-selected': showMessages}">
              <img src="./../../assets/chat-icon-2.svg" alt="">
            </div>
          </popper>

          <popper trigger="hover":options="popperOptions">
            <app-help-popper
            :title="(showEvents ? $t('general.HIDE') : $t('general.SHOW')) + ' ' + $t('help.SHOW-EVENTS-TT')"
            :details="$t('help.SHOW-EVENTS-DET')">
            </app-help-popper>

            <div slot="reference" @click="showEvents = !showEvents" class="w3-left control-btn" :class="{'control-btn-selected': showEvents}">
              <img src="./../../assets/all-events-icon.svg" alt="">
            </div>
          </popper>

        </div>

        <div class="control-group slider-container">
          <transition name="slideRightLeft">
            <div v-if="isCardsContent && !isSectionsOrder" class="">
              <div class="">
                <div class="">
                  <input ref="inputQuery" v-model="newCardQuery" class="w3-input"
                    type="text" name="" value="" placeholder="search">
                </div>
                <div @click="updateQuery()" class="control-btn control-btn-selected">
                  <i class="fa fa-refresh" aria-hidden="true"></i>
                </div>
              </div>

              <div class="w3-margin-left">
                <select v-model="cardSortBy" class="w3-input">
                  <option value="CREATION_DATE_DESC">Last Created</option>
                  <option value="EDITION_DATE_DESC">Last Edited</option>
                  <option value="CREATOR">Author</option>
                </select>
              </div>
            </div>
          </transition>
        </div>

        <div v-if="isCardsContent && isSectionsOrder" class="control-group">
          <div class="">

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="$t('help.DOWNLOAD-CONTENT-TT')"
                :details="$t('help.DOWNLOAD-CONTENT-DET')">
              </app-help-popper>

              <div slot="reference" @click="downloadContent()" class="w3-left control-btn">
                <img src="./../../assets/download-icon.svg" alt="">
              </div>
            </popper>

            <popper trigger="hover":options="popperOptions">
              <app-help-popper
                :title="(isDraggable ? $t('general.DISABLE') : $t('general.ENABLE')) + ' ' + $t('help.ENABLE-DRAG-AND-DROP-TT')"
                :details="$t('help.ENABLE-DRAG-AND-DROP-CARDS-DET')">
              </app-help-popper>

              <div slot="reference" v-if="isLoggedAnEditor" @click="draggable()" class="w3-left control-btn" :class="{'control-btn-selected': isDraggable}">
                <img src="./../../assets/move-icon.svg" alt="">
              </div>
            </popper>

          </div>
        </div>

        <div v-if="false" class="control-group text-details">
          <span v-if="isCardsContent">
            <span v-if="!isSectionsOrder">
              you are
              <span v-if="cardQuery !== ''" class="">
                searching by
                <span class="cursor-pointer" @click="resetQuery()">
                  <i><b>"{{ cardQuery }}"</b></i> <i class="fa fa-times-circle" aria-hidden="true"></i>
                </span>
              </span>
              <span v-else class="">
                searching all cards
              </span>
              under the
              <br>"{{ sectionTitle }}" section.
            </span>
            <span v-else>
              you are seeing all cards up to {{ levels }} levels under the <br>"{{ sectionTitle }}" section and respecting their in-section order.
            </span>
          </span>
          <span v-else>
            you are seeing
            <span v-if="isOnlyMessages">all messages</span>
            <span v-else>all events</span>
            up to {{ levels }} levels under the <br>"{{ sectionTitle }}" section.
          </span>

        </div>
      </div>

      <div class="elements-container">

        <app-message-thread
          v-if="isMessagesContent"
          contextType="MODEL_SECTION"
          :contextElementId="currentSectionId"
          :showMessages="showMessages"
          :showEvents="showEvents"
          :levels="999">
        </app-message-thread>

        <app-model-section
          v-if="isCardsContent && isSectionsOrder"
          :section="section"
          :cardsType="cardsType"
          :showPrivate="showPrivate"
          :showShared="showShared"
          :showCommon="showCommon">
        </app-model-section>

        <app-model-cards-container
          v-if="isCardsContent && !isSectionsOrder"
          :cardWrappers="cardWrappers"
          :inSection="section"
          :cardsType="cardsType"
          :acceptDrop="false">
        </app-model-cards-container>

        <div v-if="!isSectionsOrder && thereAreMore" class="w3-row w3-center w3-margin-top w3-margin-bottom">
          <button @click="showMore()" class="w3-button app-button-light" type="button" name="button">show more</button>
        </div>

        <div v-if="loading" class="w3-row w3-center loader-gif-container">
          <img class="loader-gif" src="../../assets/loading.gif" alt="">
        </div>

      </div>
    </div>
  </div>
</template>

<script>
import MessageThread from '@/components/notifications/MessageThread'
import ModelSection from '@/components/model/ModelSection'
import ModelCardsContainer from '@/components/model/cards/ModelCardsContainer'
import { getSortedCardWrappers, getSortedSubsections } from '@/lib/sortAlgorithm.js'

const sectionToMarkdown = function (section, level, showCommon, showShared, showPrivate) {
  var text = ''
  /* write section on text as reference */
  text += Array(level + 1).join('#') + ' '
  level = level < 5 ? level + 1 : level
  text += section.title + '\r\n'

  if (section.description !== '') {
    text += section.description + '\r\n'
  }

  let sortedCardWrappers = getSortedCardWrappers(section, showCommon, showShared, showPrivate)

  for (let ix in sortedCardWrappers) {
    let cardWrapper = sortedCardWrappers[ix]
    if (cardWrapper.card.title !== '') {
      text += Array(level + 1).join('#') + ' '
      level = level < 5 ? level + 1 : level
      text += cardWrapper.card.title + '\r\n'
    }
    text += cardWrapper.card.text + '\r\n'
  }

  let sortedSubsections = getSortedSubsections(section, showCommon, showShared, showPrivate)

  for (let ix in sortedSubsections) {
    text += sectionToMarkdown(sortedSubsections[ix], level, showCommon, showShared, showPrivate)
  }

  return text
}

export default {
  components: {
    'app-model-section': ModelSection,
    'app-model-cards-container': ModelCardsContainer,
    'app-message-thread': MessageThread
  },

  data () {
    return {
      section: null,
      showCardModal: false,
      showNewCardModal: false,
      loading: false,
      sectionLoadedOnce: false,
      sectionLoadedOnceLevels: 0,
      orderType: 'sections',
      showMessages: true,
      showEvents: true,
      newCardQuery: '',
      cardQuery: '',
      cardSortBy: 'CREATION_DATE_DESC',
      page: 0,
      pageSize: 10,
      thereAreMore: true,
      cardWrappers: []
    }
  },

  computed: {
    sectionId () {
      return this.section !== null ? this.section.id : ''
    },
    sectionTitle () {
      return this.section !== null ? this.section.title : ''
    },
    currentSectionId () {
      return this.$route.params.sectionId
    },
    isMessagesContent () {
      return this.$route.name === 'ModelSectionMessages'
    },
    isCardsContent () {
      return this.$route.name === 'ModelSectionCards' ||
        this.$route.name === 'ModelSectionCard'
    },
    levels () {
      return this.$store.getters.getActualLevels
    },
    infiniteLevels () {
      if (this.isSectionsOrder) {
        return this.$store.state.viewParameters.isInfiniteLevels
      } else {
        return true
      }
    },
    cardsType () {
      return this.$store.state.viewParameters.cardsType
    },
    showPrivate () {
      return this.$store.state.viewParameters.showPrivate
    },
    showShared () {
      return this.$store.state.viewParameters.showShared
    },
    showCommon () {
      return this.$store.state.viewParameters.showCommon
    },
    isSummary () {
      return this.cardsType === 'summary' && this.isCardsContent
    },
    isCard () {
      return this.cardsType === 'card' && this.isCardsContent
    },
    isDoc () {
      return this.cardsType === 'doc' && this.isCardsContent
    },
    isSectionsOrder () {
      return this.orderType === 'sections'
    },
    isDraggable () {
      return this.$store.state.support.triggerCardDraggingState
    },
    isLoggedAnEditor () {
      return this.$store.getters.isLoggedAnEditor
    },
    popperOptions () {
      return {
        placement: 'bottom',
        modifiers: {
          preventOverflow: {
            enabled: true,
            boundariesElement: 'viewport'
          }
        }
      }
    }
  },

  watch: {
    '$route.params.sectionId' () {
      console.log('update due to section id watch')
      this.sectionLoadedOnce = false
      this.section = null
      this.update()
    },
    '$route.name' () {
      console.log('checking card subroute due to route name watch')
      this.checkCardSubroute()
    },
    levels () {
      console.log('udpating due to levels watch')
      this.update()
    },
    cardSortBy () {
      if (!this.isSectionsOrder) {
        this.resetCards()
      } else {
        this.updateSection()
      }
    },
    '$store.state.support.triggerUpdateSectionCards' () {
      this.resetCards()
    }
  },

  methods: {
    draggable () {
      this.$store.commit('triggerCardDraggingState')
    },
    messagesContent () {
      if (this.$route.name !== 'ModelSectionMessages') {
        this.$router.push({name: 'ModelSectionMessages'})
      }
    },
    cardsContent () {
      if (this.$route.name !== 'ModelSectionCards') {
        this.$router.push({name: 'ModelSectionCards'})
      }
    },
    sectionOrder () {
      this.orderType = 'sections'
      this.update()
    },
    aggregatedOrder () {
      this.orderType = 'aggregated'
      this.resetCards()
    },
    levelUp () {
      if (!this.infiniteLevels) {
        this.$store.commit('levelUp')
      }
    },
    levelDown () {
      if (!this.infiniteLevels) {
        this.$store.commit('levelDown')
      }
    },
    toggleInifinteLevels () {
      if (this.isSectionsOrder) {
        this.$store.commit('toggleInifinteLevels')
      }
    },
    summaryView () {
      if (!this.sectionLoadedOnce || (this.sectionLoadedOnceLevels !== this.levels)) {
        this.updateSection()
      }
      this.$store.commit('setCardsType', 'summary')
      if (this.$route.name !== 'ModelSectionCards') {
        this.$router.push({name: 'ModelSectionCards'})
      }
    },
    cardView () {
      if (!this.sectionLoadedOnce || (this.sectionLoadedOnceLevels !== this.levels)) {
        this.updateSection()
      }
      this.$store.commit('setCardsType', 'card')
      if (this.$route.name !== 'ModelSectionCards') {
        this.$router.push({name: 'ModelSectionCards'})
      }
    },
    docView () {
      if (!this.sectionLoadedOnce || (this.sectionLoadedOnceLevels !== this.levels)) {
        this.updateSection()
      }
      this.$store.commit('setCardsType', 'doc')
      if (this.$route.name !== 'ModelSectionCards') {
        this.$router.push({name: 'ModelSectionCards'})
      }
    },
    showPrivateClick () {
      this.$store.commit('toggleShowPrivate')
    },
    showSharedClick () {
      this.$store.commit('toggleShowShared')
    },
    showCommonClick () {
      this.$store.commit('toggleShowCommon')
    },
    showAllClick () {
      this.$store.commit('showAllTypes')
    },
    showMore () {
      this.page = this.page + 1
      this.getMoreCards()
    },
    resetCards () {
      this.page = 0
      this.thereAreMore = true
      this.cardWrappers = []
      this.getMoreCards()
    },
    getMoreCards () {
      console.log('getting more cards')
      this.loading = true
      if (this.currentSectionId) {
        this.axios.get('/1/model/section/' + this.currentSectionId + '/cardWrappers/search',
         {
           params: {
             query: this.cardQuery,
             page: this.page,
             pageSize: this.pageSize,
             sortBy: this.cardSortBy,
             levels: 999
           }
         }).then((response) => {
          this.loading = false
          if (response.data.result === 'success') {
            if (response.data.data.content.length < this.pageSize) {
              this.thereAreMore = false
            }
            this.cardWrappers = this.cardWrappers.concat(response.data.data.content)
          }
        }).catch((err) => {
          console.log(err)
        })
      }
    },
    updateSection () {
      this.loading = true
      if (this.currentSectionId) {
        this.axios.get('/1/model/section/' + this.currentSectionId, {params: {levels: this.levels}}).then((response) => {
          this.loading = false
          this.sectionLoadedOnce = true
          this.sectionLoadedOnceLevels = this.levels
          if (response.data.result === 'success') {
            this.section = response.data.data
            this.checkCardSubroute()
          }
        }).catch((err) => {
          console.log(err)
        })
      }
    },
    updateQuery () {
      this.cardQuery = this.newCardQuery
      this.update()
    },
    resetQuery () {
      this.newCardQuery = ''
      this.updateQuery()
    },
    update () {
      if (!this.isMessagesContent) {
        if (this.isSectionsOrder) {
          this.updateSection()
        } else {
          this.resetCards()
        }
      }
    },
    checkCardSubroute () {
      this.showCardModal = false
      if (this.$route.name === 'ModelSectionCard') {
        if (this.section) {
          this.showCardModal = true
        }
      }
    },
    closeCardModal () {
      this.$router.replace({name: 'ModelSectionCards'})
    },
    downloadContent () {
      let fileContent = 'data:text/plain;charset=utf-8,'
      fileContent += sectionToMarkdown(this.section, 1, this.showCommon, this.showShared, this.showPrivate)

      var encodedUri = encodeURI(fileContent)
      var link = document.createElement('a')
      link.setAttribute('href', encodedUri)
      link.setAttribute('download', this.section.title + '.md')
      document.body.appendChild(link)

      link.click()
    },
    atKeydown (e) {
      if (document.activeElement === this.$refs.inputQuery) {
        if (e.keyCode === 13) {
          e.preventDefault()
          this.updateQuery()
        }
      }
    }
  },

  created () {
    this.update()
    this.checkCardSubroute()
  },

  mounted () {
    window.addEventListener('keydown', this.atKeydown)
  },

  destroyed () {
    window.removeEventListener('keydown', this.atKeydown)
  }
}
</script>

<style scoped>

.model-section-elements {
  height: 100%;
  display: flex;
  flex-grow: 1;
  flex-direction: column;
}

.model-section-elements-container {
  height: 100%;
  display: flex;
  flex-grow: 1;
  flex-direction: column;
}

.elements-container {
  padding: 12px 24px;
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.controls-row {
  margin: 12px 12px 6px 24px;
  min-height: 40px;
  flex-shrink: 0;
  white-space: nowrap;
  overflow-x: auto;
}

.control-group {
  margin-right: 20px;
  margin-bottom: 3px;
  display: inline-block;
  vertical-align: top;
}

.control-group div {
  display: inline-block;
}

.control-btn {
  margin-right: 4px;
}

.zoom-controls {
  min-height: 1px;
  width: 160px;
  text-align: center;
  color: #3e464e;
  background-color: #eff3f6;
  border-radius: 3px;
  transition: all 300ms ease;
}

.zoom-controls .arrow-div {
  width: 40px;
  height: 38px;
}

.zoom-controls .arrow-div img {
  margin-top: 12px;
  width: 14px;
}

.zoom-controls .arrow-div:hover {
  background-color: #ced4d9;
}

.zoom-controls .number-div {
  width: 40px;
  height: 38px;
  font-size: 19px;
  padding: 5px 12px;
}

.zoom-controls-enabled {
}

.zoom-controls .zoom-controls-cover {
  position: absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color: rgba(71, 71, 71, 0.8);
  border-radius: 3px;
}

.text-details {
  font-size: 12px;
}

.section-cards-container {
  margin-top: 15px;
}

</style>
