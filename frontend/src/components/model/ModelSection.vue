<template lang="html">

  <div v-if="section" class="section-container" ref="sectionContainer">

    <div class="slider-container">
      <transition name="slideDownUp">
        <app-model-card-modal v-if="showCardModal"
          :isNew="false"
          :initiativeId="initiativeId"
          :cardWrapperId="showCardId"
          :inSectionId="section.id"
          :inSectionTitle="section.Title"
          @close="showCardModal = false">
        </app-model-card-modal>
      </transition>
    </div>

    <div class="">

      <div v-if="expanded" class="w3-row subelements-container">
        <div class="w3-col">

          <div class="w3-row slider-container">
            <transition name="slideDownUp">
              <div v-if="showCards" class="cards-container">
                <div v-for="(cardWrapper, ix) in sortedByLikes"
                  :key="cardWrapper.id"
                  :class="cardsContainerClasses"
                  @dragover.prevent
                  @drop.prevent="cardDroped(cardWrapper.id, $event)">

                  <div class="">
                    <app-model-card-with-modal
                      :cardWrapperInit="cardWrapper"
                      :inSectionId="section.id"
                      :inSectionTitle="section.title"
                      :cardEffect="cardsAsCards">
                    </app-model-card-with-modal>
                  </div>

                </div>
              </div>
            </transition>
          </div>

            <div class="slider-container">
              <transition name="slideDownUp">

                <div v-if="showSubsections" class="subsections-container">
                  <div v-for="subsection in section.subsections"
                    :key="subsection.id"
                    class="subsection-container"
                    @dragover.prevent
                    @drop.prevent="subsectionDroped(subsection.id, $event)">

                    <app-model-section
                      :section="subsection"
                      :inElementId="section.id"
                      :inElementTitle="section.title"
                      dragType="MOVE_SUBSECTION"
                      :cardsAsCardsInit="cardsAsCards">
                    </app-model-section>
                  </div>

                </div>
              </transition>
            </div>
          </div>
        </div>
      </transition>
    </div>
  </div>

</template>

<script>
import ModelSectionHeader from '@/components/model/ModelSectionHeader.vue'
import ModelCardModal from '@/components/model/modals/ModelCardModal.vue'

export default {
  name: 'app-model-section',

  components: {
    'app-model-section-header': ModelSectionHeader,
    'app-model-card-modal': ModelCardModal
  },

  props: {
    section: {
      type: Object,
      default: null
    },
    inElementId: {
      type: String,
      default: ''
    },
    inElementTitle: {
      type: String,
      default: ''
    },
    dragType: {
      type: String
    },
    floating: {
      type: Boolean,
      default: false
    },
    cardsAsCards: {
      type: Boolean,
      default: true
    }
  },

  data () {
    return {
      loaded: false,
      showSubsections: true,
      showCards: true,
      expanded: true,
      showCardModal: false,
      showCardId: '',
      expandSubSubsecInit: false
    }
  },

  computed: {
    sortedByLikes () {
      if (!this.sortByLikes) {
        return JSON.parse(JSON.stringify(this.section.cardsWrappers))
      } else {
        var sortedArray = JSON.parse(JSON.stringify(this.section.cardsWrappers))
        return sortedArray.sort((cardA, cardB) => {
          return cardB.nLikes - cardA.nLikes
        })
      }
    },
    nCardWrappers () {
      if (this.section) {
        if (this.section.cardsWrappers) {
          return this.section.cardsWrappers.length
        } else {
          return 0
        }
      } else {
        return 0
      }
    },
    isLoggedAnEditor () {
      return this.$store.getters.isLoggedAnEditor
    },
    cardsContainerClasses () {
      return {
        'section-card-col-with-nav': this.cardsAsCards && (this.$store.state.support.expandNav && !this.$store.state.support.windowIsSmall),
        'section-card-col-no-nav': this.cardsAsCards && (!this.$store.state.support.expandNav || this.$store.state.support.windowIsSmall),
        'section-card-par': !this.cardsAsCards
      }
    }
  },

  methods: {
    cardDroped (onCardWrapperId, event) {
      var dragData = JSON.parse(event.dataTransfer.getData('text/plain'))
      if (dragData.type === 'MOVE_CARD') {
        if (dragData.fromSectionId !== '' && !event.ctrlKey) {
          /* move from section */
          this.axios.put('/1/initiative/' + this.initiativeId +
            '/model/section/' + dragData.fromSectionId +
            '/moveCard/' + dragData.cardWrapperId, {}, {
            params: {
              onSectionId: this.section.id,
              onCardWrapperId: onCardWrapperId
            }
          }).then((response) => {
            this.$store.commit('triggerUpdateModel')
          })
        } else {
          /* add existing card */
          this.axios.put('/1/initiative/' + this.initiativeId +
            '/model/section/' + this.section.id +
            '/cardWrapper/' + dragData.cardWrapperId, {}, {
            params: {
              beforeCardWrapperId: onCardWrapperId
            }
          }).then((response) => {
            this.$store.commit('triggerUpdateModel')
          })
        }
      }
    },
    dragStart (event) {
      var moveSectionData = {
        type: this.dragType,
        sectionId: this.section.id,
        fromElementId: this.inElementId
      }
      event.dataTransfer.setData('text/plain', JSON.stringify(moveSectionData))
    },
    subsectionDroped (onSubsectionId, event) {
      var dragData = JSON.parse(event.dataTransfer.getData('text/plain'))
      var url = ''

      url = '/1/initiative/' + this.initiativeId +
        '/model/section/' + dragData.fromElementId +
        '/moveSubsection/' + dragData.sectionId

      this.axios.put(url, {}, {
        params: {
          onSectionId: this.section.id,
          onSubsectionId: onSubsectionId
        }
      }).then((response) => {
        this.$store.commit('triggerUpdateModel')
      })
    },
    checkCardSubroute () {
      var found = false
      for (var ix in this.$route.matched) {
        if (this.$route.matched[ix].name === 'ModelCardInSection') {
          /* only open the model when rendering the section in the url */
          if (this.$route.params.sectionId === this.section.id) {
            this.showCardId = this.$route.params.cardId
            this.showCardModal = true
            found = true
          }
        }
      }
      if (!found) {
        this.showCardModal = false
      }
    },
    newCardFromBar () {
      this.showCards = true
      this.$emit('new-card')
    },
    newSubsectionFromBar () {
      this.showSubsections = true
      this.$emit('new-subsection')
    }
  }
}
</script>

<style scoped>

.section-container {
}

.expand-row-collapsed {
  border-bottom-left-radius: 5px;
  border-bottom-right-radius: 5px;
  overflow: hidden;
}

.expand-row button {
  width: 100%;
  text-align: center;
  padding-left: 10px;
  padding-top: 5px;
  padding-bottom: 5px;
}

.cards-container {
  padding: 6px 10px 22px 10px;
}

.section-card-col-with-nav, .section-card-col-no-nav {
  margin-bottom: 0px;
  display: inline-block;
}

@media screen and (min-width: 1700px) {
  .section-card-col-no-nav {
    width: calc(20% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 1300px) and (max-width: 1699px) {
  .section-card-col-no-nav {
    width: calc(25% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 900px) and (max-width: 1299px) {
  .section-card-col-no-nav {
    width: calc(33% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 600px) and (max-width: 899px) {
  .section-card-col-no-nav {
    width: calc(50% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (max-width: 599px) {
  .section-card-col-no-nav {
    width: calc(100% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 1700px) {
  .section-card-col-with-nav {
    width: calc(25% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 1200px) and (max-width: 1699px) {
  .section-card-col-with-nav {
    width: calc(33% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (min-width: 900px) and (max-width: 1199px) {
  .section-card-col-with-nav {
    width: calc(50% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

@media screen and (max-width: 899px) {
  .section-card-col-with-nav {
    width: calc(100% - 16px);
    margin-left: 8px;
    margin-right: 8px;
    vertical-align: top;
  }
}

.section-card-par {
  margin-bottom: 16px;
}

.empty-div {
  min-height: 22px;
  color: #d5d6d7;
  padding-right: 10px;
  margin: 3px 0px;
}

.last-add {
  margin-top: 16px;
}

.empty-div:hover {
  background-color: #bfc1c3;
  color: white;
}

.bottom-bar .fa {
  margin-top: 5px;
  font-size: 16px !important;
  margin-right: 5px;
}

.bottom-bar .button-text {
  padding-top: 5px;
}

.show-sections-button {
  width: 100%;
}

.subsection-controls-row {
  padding-left: 16px;
  margin-top: 6px;
  margin-bottom: 6px;
}

.subsections-container {
  padding-left: 16px;
  padding-top: 12px;
  padding-right: 10px;
}

.subsection-container {
  margin-bottom: 20px;
}

</style>
